<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:16px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-size:x-large; color:#333333;">Поддержка SFTP в midnight commander</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; color:#000000; background-color:#ffffff;">Это перевод заметки о моем тестировании поддержки SFTP в midnight commander. Оригинал на английском опубликован в моем</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> </span><a href="http://blog.tataranovich.com/2011/12/sftp-suppot-in-midnight-commander.html"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">блоге (http://blog.tataranovich.com/2011/12/sftp-suppot-in-midnight-commander.html)</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">.<br /><br />Продолжаю следить за разработкой поддержки SFTP в midnight commander, на этой неделе общался с автором — в поддержке sftp появилась авторизация через ssh-agent. На радостях я быстренько накидал пакет и затестил его.</span><a name="habracut"></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br /></span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />И первое разочарование — midnight не может авторизоваться через агента. Я попробовал предыдущие схемы авторизации, которые работали в предыдущей версии:<br /><br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:24px; margin-bottom:0px; margin-left:42px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">по паролю — работает без проблем;</li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:24px; margin-left:42px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">по ключу — работает, но только для ключей, которые не защищены паролем (судя по всему это ограничение библиотеки).</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Испробовав разные варианты с агентом — поинтересовался у автора, как работает у него. Оказалось, что без проблем. Позже нашел </span><a href="http://www.libssh2.org/examples/ssh2_agent.html"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">пример авторизации через ssh-agent (http://www.libssh2.org/examples/ssh2_agent.html)</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> на сайте разработчиков libssh2 и попробовал его скомпилировать<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$ </span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">gcc -o agent_auth -Wall -I/usr/include -I. -lssh2 ssh2_agent.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">ssh2_agent.c</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> In function ‘main’</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">ssh2_agent.c</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">99</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> warning</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> implicit declaration of function ‘libssh2_session_handshake’</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/home/andrey/tmp/ccmczn2V.o</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> In function `main</span><span style=" font-family:'monospace'; color:#339900; background-color:#f8f8f8;">':</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#339900; background-color:#f8f8f8;">ssh2_agent.c:(.text+0x1a8): undefined reference to `libssh2_session_handshake'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">collect2</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> ld returned </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">1</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> exit status</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Сообщение об ошибке навело на мысль, что пример рассчитан на версию, которая новее той, что находится в репозитарии debian squeeze. Попробовал собрать текущую версию libssh2 (1.3.0) и пересобрать пример с уже новой библиотекой.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$ </span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">gcc -o agent_auth -Wall -I</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$PWD</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/libssh2/include -I. -L</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$PWD</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/libssh2/lib -lssh2 ssh2_agent.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />После этого пример собрался без ошибок, но работать отказывался, ссылаясь на невозможность подключения.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">$ LD_LIBRARY_PATH=</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$PWD</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/libssh2/lib ./agent-auth localhost andrey</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">failed to connect!</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">zsh: segmentation fault  ./agent_auth localhost andrey</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Запуск под strace показал, что во-первых соединение идет на 255.255.255.255 вместо 127.0.0.1, а во вторых код примера пытается освобождать ресурсы без проверки их использования. Отсюда и segfault при выходе.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">munmap(0xb7813000, 4096)                = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">socket(PF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">connect(3, </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">{</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">sa_family=AF_INET, sin_port=htons(22), sin_addr=inet_addr(&quot;255.255.255.255&quot;)</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">}</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">, 16) = -1 ENETUNREACH (Network is unreachable)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">write(2, &quot;failed to connect!</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">\n</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">&quot;, 19failed to connect!</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">)    = 19</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">--- SIGSEGV (Segmentation fault) @ 0 (0) ---</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">+++ killed by SIGSEGV +++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">zsh: segmentation fault  strace -f ./agent_auth localhost username</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Добавил проверку перед освобождением ресурсов<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">--- ssh2_agent.c.orig   </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">2011</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">-</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">12</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">-08 </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">23</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">53</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">41.000000000</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> +</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">0300</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">+++ ssh2_agent.c    </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">2011</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">-</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">12</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">-09 </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">00</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">02</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">10.000000000</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> +</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">0300</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">@@</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> -</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">231</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">,</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">10</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> +</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">231</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">,</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">12</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">@@</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">int</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> main(</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">int</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> argc, char </span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">*argv</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">[])</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">      </span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">*/</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#968e5b;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">   </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">shutdown</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">-</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">-    libssh2_agent_disconnect(agent);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">-    libssh2_agent_free(agent);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">+   </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">if</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (agent) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">+       libssh2_agent_disconnect(agent);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">+</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">+       libssh2_agent_free(agent);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">+   }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">     </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">if</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">(session) {</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />После чего пересобрал и запустил.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">$ gcc -o agent_auth -Wall -I</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$PWD</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/libssh2/</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">include</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> -I. -L</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$PWD</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/libssh2/lib -lssh2 ssh2_agent.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">$ LD_LIBRARY_PATH=</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$PWD</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/libssh2/lib ./agent_auth localhost andrey</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">failed to connect!</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Уже лучше — segfault на выходе исчез, но ругается на невозможность подключиться. Снова смотрю в код. Для преобразования хоста в формат понятный функции connect() используется inet_addr()<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">if</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (argc &gt; </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">1</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">        hostaddr = inet_addr(argv[</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">1</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">]);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    } </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">else</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">        hostaddr = htonl(</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">0x7F000001</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Смотрю в man 3 inet_addr и вижу, что функция преобразует символьную запись ip адреса в его бинарное представление. Bingo! Я ведь передаю имя хоста как localhost. Заменив localhost на 127.0.0.1 получаю работающий пример.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">$ LD_LIBRARY_PATH=</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$PWD</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/libssh2/lib ./agent_auth </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">127.0</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">.</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">0.1</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> andrey</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">Fingerprint: FA F3 </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">92</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">9</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">E C4 AE </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">14</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> B4 FC BE ED </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">2</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">A E8 </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">33</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">0</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">C </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">1</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">E </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">34</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">09</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">9</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">F B3 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">Authentication methods: publickey,password</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    Authentication with username andrey </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">and</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">public</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> key /home/andrey/.ssh/id_rsa failed!</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    Authentication with username andrey </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">and</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">public</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> key /home/andrey/.ssh/id_dsa succeeded!</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">all done!</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Теперь дело за малым — собрать версию libssh2 (1.3.0) для squeeze и пересобрать midnight с новой версией библиотеки. Готовую сборку можно забрать </span><a href="http://www.tataranovich.com/public/mc-sftp/2011-12-08/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">тут (http://www.tataranovich.com/public/mc-sftp/2011-12-08/)</span></a></p></body></html>