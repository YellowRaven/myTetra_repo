<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:16px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-size:x-large; color:#333333;">Разбираем исходный код GNU Coreutils: утилита yes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:x-large; color:#999999;">Зачем?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Все вокруг постоянно говорят: «Хочешь научиться писать профессиональные программы? Посмотри, как это делают другие!». Вот и я решил последовать этому совету, тем более что моё обучение в университете как раз подходит к концу. Особенно интересно сравнить то как учили делать и то как делается в реальном мире. В качестве примера для подражания был выбран пакет </span><a href="http://www.gnu.org/s/coreutils/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">GNU Coreutils</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. В нём есть всё:<br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:24px; margin-bottom:0px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Жёсткие требования к переносимости.</li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Большой жизненный цикл.</li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Огромная команда разработчиков.</li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:24px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Код различной сложности: от тривиального echo до супер-изощерённого sed, от чисто прикладного wc до более близкого к ОС mkdir.<a name="habracut"></a><br /></li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:x-large; color:#999999;">GNU Coreutils</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />GNU Core Utilites — это набор утилит для выполнения базовых пользовательских операций: создание директории, вывод файла на экран и так далее. По замыслу разработчиков, эти утилиты должны быть доступны в любой операционной системе, что мы и наблюдаем в настоящее время: для Windows есть</span><a href="http://www.cygwin.com/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">Cygwin</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, ну а про *nix и говорить нечего. Сохранить единообразность работы в разных системах помогает стандарт </span><a href="http://ru.wikipedia.org/wiki/POSIX"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">POSIX</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, который в Coreutils пытаются </span><a href="http://www.gnu.org/s/coreutils/manual/html_node/Standards-conformance.html"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">соблюдать</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Coreutils содержит такие часто используемые утилиты, как cat, tail, echo, wc и многие другие.<br /><br />Для начала выберем самую тривиальную программу под названием yes. Её простота позволит разобраться с используемыми в Coreutils инструментами и библиотеками.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">Утилита yes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Как говорится в </span><a href="http://www.linuxmanpages.com/man1/yes.1.php"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">мане</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, всё что умеет утилита yes — это бесконечно выводить «yn» в stdout. Если мы передадим yes какие-то аргументы, то вместо «y» yes будет выводить аргументы через пробел. Наверняка похожую программу писал каждый, кто начинал изучать C. А значит у многих есть возможность сравнить свой подход с тем, как это делают суровые бородатые дядьки из GNU. О практическом применении yes немного написано в </span><a href="http://en.wikipedia.org/wiki/Yes_%28Unix%29"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">Википедии</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:x-large; color:#999999;">Исходный код</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Переходим к исходному коду. Достать его можно либо с помощью </span><span style=" font-family:'monospace'; color:#000000;">apt-get source</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> и получить версию, которая используется в вашей системе по-умолчанию, либо вытянуть новейшую версию из репозиториев. Мы выберем второй вариант: он более удобен и привычен.<br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:24px; margin-bottom:0px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Coreutils: <span style=" font-family:'monospace';">git clone git://git.sv.gnu.org/coreutils</span></li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:24px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Gnulib (заглянем туда пару раз): <span style=" font-family:'monospace';">git clone git://git.savannah.gnu.org/gnulib.git</span></li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Исходный код yes умещается в одном файле </span><span style=" font-family:'monospace'; color:#000000;">coreutils/src/yes.c</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, его и откроем.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">Coding style</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Первое, на что обращаешь внимание — непривычное форматирование кода. Почитать о нём можно в</span><a href="http://www.gnu.org/prep/standards/standards.html#Formatting"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">соответствующей главе</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> GNU Coding Standards. Например, при определении функции тип возвращаемого значения должен располагаться на отдельной строке, как и открывающая скобка:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">int</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">main (</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">int</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> argc, </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">char</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> **argv)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  foo();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Для отступов и выравнивания используются только пробелы. Между различными уровнями вложенности разница в отступе составляет 2 пробела. Особо извращённую форму имеют фигурные скобки при операторах:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">if</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">x</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> &lt; foo (</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">y</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">, z))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  haha = bar[</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">4</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">] + </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">5</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">while</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (z)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">      {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">        haha += foo (z, z);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">        z--;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">      }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">return</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> ++</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">x</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> + bar ();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">12 строк</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br /></span><span style=" font-family:'monospace'; color:#000000;">yes.c</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> начинается с обязательного для всех GPL-програм комментария. Он уже успел намозолить мне глаза в других программах и необходимость его наличия была для меня загадкой. Оказывается, что текст этого комментария зафиксирован в </span><a href="http://www.gnu.org/licenses/gpl-howto.html"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">инструкции</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> по применению GPL. Именно в ней прописано, что все, кто желает выпускать своё ПО под GPL, должны добавлять эти 12 строк заявления о праве копирования в начало каждого файла исходного кода.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">initialize_main</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Первое, что делает программа, это вызов </span><span style=" font-family:'monospace'; color:#000000;">initialize_main</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Эта функция предназначена для того, чтобы программа выполнила свои специфичные действия над аргументами. На практике, в Coreutils нет ни одной утилиты, которая бы использовала эту функцию для чего-то полезного. Везде используется заглушка, представленная в файле </span><span style=" font-family:'monospace'; color:#000000;">coreutils/src/system.h</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#808080; background-color:#f8f8f8;">#ifndef initialize_main</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#808080; background-color:#f8f8f8;"># define initialize_main(ac, av)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#808080; background-color:#f8f8f8;">#endif</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#808080;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">Название программы</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />В утилитах Coreutils различают два названия программы:<br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:24px; margin-bottom:0px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Официальное название, которое пользователь не может изменить.</li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:24px; margin-left:48px; margin-right:16px; -qt-block-indent:0; text-indent:0px;">Реальное название исполняемого файла.</li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Официальное название используется при выводе информации о версии приложения:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">user</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">@laptop:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">~</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$ </span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">yes --version</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">yes (GNU coreutils) </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">8.5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">Usage</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> yes [STRING]...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">or</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  yes OPTION</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Причём это название никак не зависит от имени исполняемого файла:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">user</span><span style=" font-family:'monospace'; color:#808000; background-color:#f8f8f8;">@laptop</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:~$ /usr/bin/yes --version</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">yes (GNU coreutils) </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">8.5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">user</span><span style=" font-family:'monospace'; color:#808000; background-color:#f8f8f8;">@laptop</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:~$ cp /usr/bin/yes ./foo</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">user</span><span style=" font-family:'monospace'; color:#808000; background-color:#f8f8f8;">@laptop</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">:~$ ./foo --version</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">yes (GNU coreutils) </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">8.5</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#2f98ff;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Такое поведение обеспечивается специально определённым в начале файла макросом </span><span style=" font-family:'monospace'; color:#000000;">PROGRAM_NAME</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#808080; background-color:#f8f8f8;">/* The official name of this program (e.g., no `g' prefix).  */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#808080; background-color:#f8f8f8;">#define PROGRAM_NAME &quot;yes&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#808080;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Реальное название без всяких хитростей берётся из </span><span style=" font-family:'monospace'; color:#000000;">argv[0]</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> и используется при выводе ошибок и подсказок:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">user</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">@laptop:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">~</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$ </span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">yes --help</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">Usage</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> yes [STRING]...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">or</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  yes OPTION</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">user</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">@laptop:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">~</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">$ </span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">/usr/bin/yes --help</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">Usage</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> /usr/bin/yes [STRING]...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">or</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">:</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  /usr/bin/yes OPTION</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Значение </span><span style=" font-family:'monospace'; color:#000000;">argv[0]</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> помещается в глобальную переменную </span><span style=" font-family:'monospace'; color:#000000;">program_name</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> с помощью вызова функции </span><span style=" font-family:'monospace'; color:#000000;">set_program_name</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> во второй строке </span><span style=" font-family:'monospace'; color:#000000;">main</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">set_program_name (argv[0]);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Функция </span><span style=" font-family:'monospace'; color:#000000;">set_program_name</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> предоставляется библиотекой </span><a href="http://www.gnu.org/s/gnulib/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">Gnulib</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Соответствующий код находится в каталоге</span><span style=" font-family:'monospace'; color:#000000;">gnulib/lib/</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, в файлах </span><span style=" font-family:'monospace'; color:#000000;">progname.h</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> и </span><span style=" font-family:'monospace'; color:#000000;">progname.c</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Интересно заметить, что </span><span style=" font-family:'monospace'; color:#000000;">set_program_name</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> не просто сохраняет значения </span><span style=" font-family:'monospace'; color:#000000;">argv[0]</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> в глобальную переменную </span><span style=" font-family:'monospace'; color:#000000;">program_name</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, объявленную в </span><span style=" font-family:'monospace'; color:#000000;">progname.h</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, но и выполняет дополнительные преобразования, связанные с тонкостями использования </span><a href="http://www.gnu.org/software/libtool/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">GNU Libtool</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, инструмента для разработки динамических библиотек.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">Интернационализация</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Coreutils используют по всему миру, поэтому во всех утилитах предусмотрена возможность локализации. Причём эта возможность обеспечивается минимальными усилиями благодаря использованию пакета </span><a href="http://www.gnu.org/s/gettext/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">GNU gettext</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Немногих удивит использование именно gettext, ведь этот пакет распространился далеко за пределы проекта GNU. Например, интернационализация в моём любимом web-фреймворке Django построена</span><a href="https://docs.djangoproject.com/en/dev/topics/i18n/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">именно на gettext</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Про использование gettext совместно с различными языками и фреймворками уже писали на </span><a href="http://habrahabr.ru/tag/gettext/"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">хабре</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">.<br /><br />Замечательным свойством gettext является то, что он во всех языках используется примерно одинаково, и C не исключение. Здесь есть стандартная магическая функция </span><span style=" font-family:'monospace'; color:#000000;">_</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, использование которой можно найти в функции </span><span style=" font-family:'monospace'; color:#000000;">usage</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">void</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">usage (</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">int</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> status)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">if</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (status != EXIT_SUCCESS)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    fprintf (stderr, _(</span><span style=" font-family:'monospace'; color:#339900; background-color:#f8f8f8;">&quot;Try `%s --help' for more information.\n&quot;</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">),</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">             program_name);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Определение функции </span><span style=" font-family:'monospace'; color:#000000;">_</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> находится в уже знакомом нам файле </span><span style=" font-family:'monospace'; color:#000000;">system.h</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#808080; background-color:#f8f8f8;">#define _(msgid) gettext (msgid)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#808080;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Инициализация механизма интернационализации в Coreutils производится вызовом трёх функций в </span><span style=" font-family:'monospace'; color:#000000;">main</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">setlocale (LC_ALL, &quot;&quot;);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">bindtextdomain (PACKAGE, LOCALEDIR);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">textdomain (PACKAGE);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:24px; margin-bottom:0px; margin-left:42px; margin-right:16px; -qt-block-indent:0; text-indent:0px;"><a href="http://linux.die.net/man/3/setlocale"><span style=" text-decoration: underline; color:#6da3bd;">setlocale</span></a> устанавливает стандартную локаль окружения в качестве рабочей для приложения</li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:42px; margin-right:16px; -qt-block-indent:0; text-indent:0px;"><a href="http://linux.die.net/man/3/bindtextdomain"><span style=" text-decoration: underline; color:#6da3bd;">bindtextdomain</span></a> говорит, где искать файл с переводами для конкретного домена сообщений</li>
<li style=" font-family:'Verdana,sans-serif'; color:#000000;" style=" margin-top:0px; margin-bottom:24px; margin-left:42px; margin-right:16px; -qt-block-indent:0; text-indent:0px;"><a href="http://linux.die.net/man/3/textdomain"><span style=" text-decoration: underline; color:#6da3bd;">textdomain</span></a> устанавливает текущий домен сообщений</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">Обработка ошибок</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Двигаясь дальше по коду </span><span style=" font-family:'monospace'; color:#000000;">main</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, мы встречаем такую строку:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">atexit (close_stdout);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Интуитивно можно подумать, что в функции </span><span style=" font-family:'monospace'; color:#000000;">close_stdout</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> закрывается стандартный поток вывода, что исключает потерю данных, если мы подменили </span><span style=" font-family:'monospace'; color:#000000;">stdout</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> каким-нибудь файловым дескриптором и используем буферизированный вывод. Но найти исходный код этой функции и понять, что же на самом деле там происходит, выполняются ли какие-нибудь дополнительные действия по подчистке ресурсов, у меня не получилось.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">Аргументы командной строки</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Это последний вопрос, который не касается работы самой программы. Здесь, как и в случае с интернационализацией, используется проверенное временем и пролезшее во многие проекты (например, </span><a href="http://docs.python.org/library/getopt.html"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">в Python</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">) решение — модуль </span><a href="http://www.gnu.org/s/hello/manual/libc/Getopt.html"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">getopt</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Этот модуль очень прост: фактически, от разработчика требуется вызывать в цикле одну из функций </span><span style=" font-family:'monospace'; color:#000000;">getopt</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> или </span><span style=" font-family:'monospace'; color:#000000;">getopt_long</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Подробнее о getopt можно почитать в интернете, да и на хабре о нём тоже писали.<br /><br />В Gnulib есть специальная функция </span><span style=" font-family:'monospace'; color:#000000;">parse_long_options</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> для обработки аргументов </span><span style=" font-family:'monospace'; color:#000000;">--version</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> и </span><span style=" font-family:'monospace'; color:#000000;">--help</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, которые любое GNU-приложение </span><a href="http://www.gnu.org/prep/standards/standards.html#Command_002dLine-Interfaces"><span style=" font-family:'Verdana,sans-serif'; text-decoration: underline; color:#6da3bd;">обязано</span></a><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> поддерживать. Находится она в файле </span><span style=" font-family:'monospace'; color:#000000;">gnulib/lib/long-options.c</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> и использует </span><span style=" font-family:'monospace'; color:#000000;">getopt_long</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> в своей работе.<br /><br />Исходный код yes является классным примером работы с getopt. Тут одновременно отсутствует излишняя для обучения сложность с разбором десятков аргументов и присутствует использование всех средств getopt. Сначала, естественно, выполняется вызов </span><span style=" font-family:'monospace'; color:#000000;">parse_long_options</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">. Затем проверяется, что больше никаких опций-ключей не передано и остальные аргументы, если они есть, являются просто произвольными строками:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">parse_long_options (argc, argv, PROGRAM_NAME, PACKAGE_NAME, Version,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">                    usage, AUTHORS, (char </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">const</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> *) </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">NULL</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">if</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (getopt_long (argc, argv, </span><span style=" font-family:'monospace'; color:#339900; background-color:#f8f8f8;">&quot;+&quot;</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">, </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">NULL</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">, </span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">NULL</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">) != -</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">1</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    usage (EXIT_FAILURE);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Следующий код можно перевести на русский так: «Если в списке аргументов командой строки ничего кроме ключей --version и --help не было, то мы будем выводить „y“ в stdout»:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">if</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (argc &lt;= optind)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    optind = argc;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    argv[argc++] = bad_cast (</span><span style=" font-family:'monospace'; color:#339900; background-color:#f8f8f8;">&quot;y&quot;</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#000000;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Запись в </span><span style=" font-family:'monospace'; color:#000000;">argv[argc]</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> не является ошибкой: стандарт ANSI C требует, чтобы элемент </span><span style=" font-family:'monospace'; color:#000000;">argv[argc]</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;"> был нулевым указателем.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#999999;">Главный цикл</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Ну вот мы и добрались до самого функционала программы. Вот он весь, как есть:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">while (true)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    int i;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    for (i = optind; i &lt; argc; i++)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">      if (fputs (argv</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">[</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">i</span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">]</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">, stdout) == EOF</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">          || putchar (i == argc - 1 ? '</span><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">\n</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">' : ' ') == EOF)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">        error (EXIT_FAILURE, errno, _(&quot;standard output&quot;));</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">  </span><span style=" font-family:'monospace'; color:#2f98ff; background-color:#f8f8f8;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; color:#2f98ff;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; color:#000000;"><br />Здесь можно отметить, что все действия выполняются внутри условия </span><span style=" font-family:'monospace'; color:#000000;">if</span><span style=" font-family:'Verdana,sans-serif'; color:#000000;">, а не в его теле. Значит, Кёрниган и Ритчи не врали, когда писали, что опытный C-программист реализует копирование строк так:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#4d7386; background-color:#f8f8f8;">while</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;"> (</span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">*dst</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">++ = </span><span style=" font-family:'monospace'; color:#968e5b; background-color:#f8f8f8;">*src</span><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">++)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#000000; background-color:#f8f8f8;">    ;</span></p></body></html>